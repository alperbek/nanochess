<script>
//(c)2010 Oscar Toledo G.

var B, // source position of the move
    i, // current piece code
    y, // current player: 0 - white, 8 - black
    u,
    b, // target position of the move
    I = [], // chessboard (12 rows x 10 columns, see wiki for more info)
    G = 120,
    x = 10, // just ten ;)
    z = 15, // just fifteen ;)
    M = 10000,
    l = [5,3,4,6,2,4,3,5, // initial black pieces setup
         1,1,1,1,1,1,1,1,
         9,9,9,9,9,9,9,9, // same, but for white pieces
         13,11,12,14,10,12,11,13,
         0,99,0,306,297,495,846,-1,0,1,2,2,1,0,-1, // ???
         -1,1,-10,10,-11,-9,9,11,10,20, // king, rook & queen moves (at 47), bishop (at 51), black pawn (at 53)
         -9,-11,-10, // white pawn moves (at 57)
         -20,-21,-19,-12,-8,8,12,19,21] // knight moves (at 61)

function X(w,c,h,e,S,s) {
    var t,
        o,
        L,
        E,
        d,
        O = e,
        N = -M*M,
        K = 78 - h<<x,
        p,
        g,
        n,
        m,
        A,
        q,
        r,
        C,
        J,
        a = y ? -x : x;
    y ^= 8;
    G++;
    d = w || (s && s>=h && X(0,0,0,21,0,0) > M);
    do {
        p = O; // current position
        o = I[p]; // current piece code (or'ed with 16) or 0
        if (o) {
            q = o & z ^ y; // current piece code (1..6 for current player, 9..15 for opponent)
            if (q < 7) {
                A = (q-- & 2) ? 8 : 4; // possible moves (8 for queen, king, knight)
                C = ((o-9) & z) ? [53,47,61,51,47,47][q] : 57; // offset of possible moves
                // for each possible move ...
                do {
                    p += l[C]; // target cell position
                    r = I[p]; // piece code at the target cell
                    if (!w | p == w) {
                        g = (q | p + a - S) ? 0 : S;
                        if ((!r & (!!q | A<3 || !!g)) || ((r+1&z^y)>9 && (q | A>2))) {
                            m = !(r - 2 & 7);
                            if (m) {
                                y ^= 8;
                                I[G--] = O;
                                return K;
                            }
                            J = n = o & z;
                            E = I[p - a] & z;
                            t = (q | E-7) ? n : (n+=2,6^y);
                            while (n <= t) {
                                L = r ? l[r&7|32]-h-q : 0;
                                if (s) {
                                    L+=((1-q) ? l[(p-p%x)/x+37] - l[(O-O%x)/x+37] + l[p%x+38]*(q?1:2) - l[O%x+38]+(o&16)/2
                                              : !!m * 9) +
                                       (!q ? !(I[p-1]^n) + !(I[p+1]^n) + l[n&7|32] - 99 + !!g * 99 + (A<2)
                                           : 0) +
                                       !(E ^ y ^ 9);
                                }
                                if ((s > h) || ((1<s & s==h) && (L>z | d))) {
                                    I[p] = n;
                                    I[O] = m ? (I[g] = I[m], I[m] = 0)
                                             : g ? I[g]=0 : 0;
                                    L -= X((s > h | d) ? 0 : p,
                                           L - N,
                                           h + 1,
                                           I[G+1],
                                           J = (q|A>1) ? 0 : p,
                                           s);
                                    if (!(h || (s-1 | B-O | i-n | p-b | L<-M))) {
                                        DrawPieces();
                                        G--;
                                        u=J;
                                        return u;
                                    }
                                    J = (q-1 | A<7) || m || (!s | d | r | o<z) || X(0,0,0,21,0,0) > M;
                                    I[O] = o;
                                    I[p] = r;
                                    if (m) {
                                        I[m] = I[g];
                                        I[g] = 0;
                                    } else if (g) {
                                        I[g] = 9 ^ y;
                                    }
                                }
                                if (L>N || (s>1 && L==N && !h && Math.random()<.5)) {
                                    I[G] = O;
                                    if (s > 1) {
                                        if (h && c-L < 0) {
                                            y ^= 8;
                                            G--;
                                            return L;
                                        }
                                        if (!h) {
                                            i = n;
                                            B = O;
                                            b = p;
                                        }
                                    }
                                    N = L;
                                }
                                n += J || (g = p,
                                           m = (p < O) ? g-3 : g+2,
                                           (I[m] < z | I[m+O-p]) || I[p+=p-O]) ? 1 : 0;
                            }
                        }
                    }
                } while ((!r & q>2) || (p=O, (q | A > 2 | o > z & !r) && (++C * --A)));
            }
        }
    } while ((++O > 98) ? O = 20 : e - O);
    y ^= 8;
    G--;
    return (N + M*M && (N > 1924-K | d)) ? N : 0;
}

y = u = 0;

function SetupChessboard() {
    var x, y;
    var i = 0;
    for (y=0; y<12; y++) {
        for (x=0; x<10; x++) {
            if (x<1 || y<2 || x>8 || y>9) {
                // outside
                I[y*10+x] = 7;
            } else if (y>=4 && y<=7) {
                // empty
                I[y*10+x] = 0;
            } else {
                // pieces
                I[y*10+x] = l[i++] | 16;
            }
        }
    }
}

function CreateChessboardView() {
    var x, y, i;
    var a = "<table cellspacing=0 align=center>";
    for (y=0; y<8; y++) {
        a += "<tr>";
        for (x=0; x<8; x++) {
            i = y*10 + x + 21;
            a += "<th width=60 height=60 onclick=OnClick(" + i + ") id=o" + i +
                 " style='line-height:50px;font-size:50px;border:2px solid #dde' bgcolor=#" +
                 (((x+y) & 1) ? "c0c0f0>" : "f0f0f0>");
        }
        a += "</tr>";
    }
    a += "<tr><th colspan=8><select id=t style='font-size:20px'>";
    a += "<option>&#9819;<option>&#9820;<option>&#9821;<option>&#9822;";
    a += "</select></tr></table>";
    document.write(a);
}

function DrawPieces() {
    var pieces = "\xa0\u265f\u265a\u265e\u265d\u265c\u265b  \u2659\u2654\u2658\u2657\u2656\u2655";
    var p, q;
    B=b;
    for (p=21; p<99; ++p) {
        if (q = document.getElementById("o" + p)) {
            q.innerHTML = pieces.charAt(I[p] & 15);
            q.style.borderColor = (p == B) ? "red" : "#dde";
        }
    }
}

function OnClick(s) {
    i = (I[s] ^ y) & z;
    if (i > 8) {
        // clicked on the own piece
        b = s;
        DrawPieces();
    } else if (B && i<9) {
        // clicked on the opponent piece or empty space
        b = s;
        i = I[B] & z;
        // pawn promotion
        if ((i & 7) == 1 & (b < 29 | b > 90))
            i = 14 - document.getElementById("t").selectedIndex ^ y;
        // verify player move??
        X(0,0,0,21,u,1);
        // Call A.I. after some delay
        if (y) {
            setTimeout("X(0,0,0,21,u,2/*ply*/),X(0,0,0,21,u,1)",250);
        }
    }
}

SetupChessboard();
CreateChessboardView();
DrawPieces();

i = 100;

</script>
